<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ממשק מפעיל רשמי</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
</head>
<body>
  <h1>ממשק מפעיל רשמי</h1>
  <div id="controls">
    <button id="join-btn">הצטרף כ־מפעיל</button>
    <button id="share-screen-btn" disabled>שתף מסך</button>
    <button id="toggle-camera-btn" disabled>כבה/הפעל מצלמה</button>
    <button id="toggle-mic-btn" disabled>כבה/הפעל מיקרופון</button>
  </div>
  <div id="video-container"></div>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script>
    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    const urlParams = new URLSearchParams(location.search);
    const CHANNEL_NAME = urlParams.get('channel');
    const UID = urlParams.get('uid');

    let localTracks = {};
    let joined = false;

    document.getElementById('join-btn').onclick = async () => {
      if (joined) return;
      await client.join(AGORA_APP_ID, CHANNEL_NAME, AGORA_TOKEN, UID);
      const [audioTrack, videoTrack] = await AgoraRTC.createMicrophoneAndCameraTracks();
      localTracks.audioTrack = audioTrack;
      localTracks.videoTrack = videoTrack;
      await client.publish([audioTrack, videoTrack]);
      joined = true;
      document.getElementById('share-screen-btn').disabled = false;
      document.getElementById('toggle-camera-btn').disabled = false;
      document.getElementById('toggle-mic-btn').disabled = false;
      videoTrack.play(createVideoContainer('local-camera'));
      audioTrack.play();
    };

    document.getElementById('share-screen-btn').onclick = async () => {
      const btn = document.getElementById('share-screen-btn');
      if (!localTracks.screenTrack) {
        localTracks.screenTrack = await AgoraRTC.createScreenVideoTrack();
        await client.publish(localTracks.screenTrack);
        localTracks.screenTrack.play(createVideoContainer('local-screen'));
        btn.innerText = 'עצור שיתוף';
      } else {
        localTracks.screenTrack.stop();
        localTracks.screenTrack.close();
        await client.unpublish(localTracks.screenTrack);
        removeVideoContainer('local-screen');
        localTracks.screenTrack = null;
        btn.innerText = 'שתף מסך';
      }
    };

    document.getElementById('toggle-camera-btn').onclick = () => {
      const t = localTracks.videoTrack;
      if (!t) return;
      t.setEnabled(!t.enabled);
      document.getElementById('toggle-camera-btn').innerText = t.enabled ? 'כבה מצלמה' : 'הפעל מצלמה';
    };

    document.getElementById('toggle-mic-btn').onclick = () => {
      const t = localTracks.audioTrack;
      if (!t) return;
      t.setEnabled(!t.enabled);
      document.getElementById('toggle-mic-btn').innerText = t.enabled ? 'כבה מיקרופון' : 'הפעל מיקרופון';
    };

    function createVideoContainer(id) {
      const div = document.createElement('div');
      div.id = id;
      document.getElementById('video-container').appendChild(div);
      return id;
    }
    function removeVideoContainer(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }
  </script>
</body>
</html>
