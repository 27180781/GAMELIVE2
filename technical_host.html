<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>××¤×¢×™×œ ×˜×›× ×™ â€“ ×©×™×ª×•×£ ××¡×š ×‘×œ×‘×“</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:Arial,sans-serif; direction:rtl; }
    #container { display:flex; height:calc(100vh - 60px); }
    #previews { flex:1; display:flex; }
    #screen-preview, #cam-preview {
      flex:1; background:#000; margin:5px; display:flex; align-items:center; justify-content:center;
    }
    video { width:100%; height:100%; object-fit:contain; }
    #controls {
      height:60px; background:#222; display:flex; align-items:center; justify-content:center; gap:15px;
    }
    #controls button { padding:8px 16px; cursor:pointer; }
  </style>
</head>
<body>

  <!-- ×›×¤×ª×•×¨×™×: ×”×¦×˜×¨×£ ×œ×©×™×ª×•×£ ××¡×š + ××™×§×¨×•×¤×•×Ÿ + ×›×¤×ª×•×¨×™ Toggle -->
  <div id="controls">
    <button id="join-btn">×”×ª×—×œ ×©×™×ª×•×£ ××¡×š + ××™×§×¨×•×¤×•×Ÿ</button>
    <button id="toggle-screen-btn" disabled>×¢×¦×•×¨/×”××©×š ×©×™×ª×•×£ ××¡×š</button>
    <button id="toggle-mic-btn" disabled>×›×‘×”/×”×¤×¢×œ ××™×§×¨×•×¤×•×Ÿ</button>
  </div>

  <!-- ×ª×¦×•×’×•×ª ××§×“×™××•×ª: ×©×××œ×™×ª ×©×™×ª×•×£ ××¡×š ××§×•××™, ×™×× ×™×ª ××¦×œ××ª ×× ×—×” ×¨×©××™ -->
  <div id="container">
    <div id="screen-preview">×××ª×™×Ÿ ×œ×©×™×ª×•×£ ××¡×šâ€¦</div>
    <div id="cam-preview">×××ª×™×Ÿ ×œ××¦×•×œ×â€¦</div>
  </div>

  <!-- ×”×¦â€™××˜ -->
  <div id="chat-container">
    <div id="chat-header">×¦'××˜</div>
    <div id="chat-messages"></div>
    <form id="chat-form"><input id="chat-input" placeholder="×›×ª×•×‘ ×”×•×“×¢×”â€¦"></form>
  </div>
  <button id="chat-toggle-btn">ğŸ’¬</button>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script src="https://download.agora.io/rtm/release/AgoraRTM_N-4.14.0.js"></script>
  <script src="config.js"></script>  <!-- AGORA_APP_ID, AGORA_TOKEN :contentReference[oaicite:2]{index=2} -->
  <script src="chat.js"></script>    <!-- initChat(...) :contentReference[oaicite:3]{index=3} -->

  <script>
    const rtcClient = AgoraRTC.createClient({ mode:"live", codec:"vp8" });
    rtcClient.setClientRole("host");
    const rtmClient = AgoraRTM.createInstance(AGORA_APP_ID);

    const params      = new URLSearchParams(location.search);
    const channel     = params.get("channel");
    const uid         = Number(params.get("uid"));
    const officialUid = Number(params.get("official_uid"));

    let screenTrack, micTrack;

    document.getElementById("join-btn").onclick = async () => {
      const displayName = prompt("×”×›× ×¡ ×©× ×œ×ª×¦×•×’×ª ×”×¦'××˜:");
      // ×”×¦×˜×¨×¤×•×ª ×œÖ¾RTC ×•Ö¾RTM
      await rtcClient.join(AGORA_APP_ID, channel, AGORA_TOKEN, uid);
      await initChat(rtmClient, channel, uid.toString(), displayName);

      // ×™×¦×™×¨×ª ×©×™×ª×•×£ ××¡×š (1080p + ×¡××•× ×“) + ××™×§×¨×•×¤×•×Ÿ
      screenTrack = await AgoraRTC.createScreenVideoTrack({ encoderConfig:"1080p_2", withAudio:true });
      micTrack    = (await AgoraRTC.createMicrophoneAndCameraTracks())[0];
      await rtcClient.publish([ screenTrack, micTrack ]);

      // ×ª×¦×•×’×” ××§×•××™×ª
      screenTrack.play("screen-preview");

      // ××¤×©×¨ ×›×¤×ª×•×¨×™×
      document.getElementById("toggle-screen-btn").disabled = false;
      document.getElementById("toggle-mic-btn").disabled    = false;
    };

    // Toggle ×©×™×ª×•×£ ××¡×š
    document.getElementById("toggle-screen-btn").onclick = async () => {
      const btn = document.getElementById("toggle-screen-btn");
      if (screenTrack) {
        await rtcClient.unpublish(screenTrack);
        screenTrack.stop();
        screenTrack.close();
        document.getElementById("screen-preview").innerHTML = "×©×™×ª×•×£ ××¡×š × ×¢×¦×¨";
        screenTrack = null;
        btn.textContent = "×”××©×š ×©×™×ª×•×£ ××¡×š";
      } else {
        screenTrack = await AgoraRTC.createScreenVideoTrack({ encoderConfig:"1080p_2", withAudio:true });
        await rtcClient.publish(screenTrack);
        screenTrack.play("screen-preview");
        btn.textContent = "×¢×¦×•×¨ ×©×™×ª×•×£ ××¡×š";
      }
    };

    // Toggle ××™×§×¨×•×¤×•×Ÿ
    document.getElementById("toggle-mic-btn").onclick = () => {
      const btn = document.getElementById("toggle-mic-btn");
      micTrack.setEnabled(!micTrack.enabled);
      btn.textContent = micTrack.enabled ? "×›×‘×” ××™×§×¨×•×¤×•×Ÿ" : "×”×¤×¢×œ ××™×§×¨×•×¤×•×Ÿ";
    };

    // ×××–×™×Ÿ ×œÖ¾remote camera ×©×œ ×”×× ×—×” ×”×¨×©××™
    rtcClient.on("user-published", async (user, mediaType) => {
      await rtcClient.subscribe(user, mediaType);
      if (user.uid === officialUid && mediaType === "video") {
        user.videoTrack.play("cam-preview");
      }
      if (user.uid === officialUid && mediaType === "audio") {
        user.audioTrack.play();
      }
    });

    // ×¦â€™××˜ â€“ ×›×¤×ª×•×¨ ×¤×ª×™×—×”/×¡×’×™×¨×”
    document.getElementById("chat-toggle-btn").onclick = () => {
      document.getElementById("chat-container").classList.toggle("open");
    };
  </script>
</body>
</html>
