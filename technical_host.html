<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>מפעיל טכני – שיתוף מסך ומיקרופון + תצוגת מצלמה רשמית</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:Arial,sans-serif; direction:rtl }
    #controls { height:60px; background:#222; display:flex; align-items:center; justify-content:center; gap:10px }
    #controls button { padding:8px 16px; cursor:pointer; color:#fff; background:#444; border:none }
    #previews { display:flex; height:calc(100vh - 60px) }
    #screen-preview, #cam-preview {
      flex:1; margin:5px; background:#000; display:flex; align-items:center; justify-content:center
    }
    video { width:100%; height:100%; object-fit:contain }
    /* צ'אט */
    #chat-container { position:absolute; bottom:10px; left:10px; width:300px; max-height:400px; display:none; flex-direction:column; background:rgba(0,0,0,0.7); color:#fff }
    #chat-header { padding:8px; background:#333 }
    #chat-messages { flex:1; overflow-y:auto; padding:8px }
    #chat-form { display:flex }
    #chat-input { flex:1; padding:6px; border:none }
    #chat-toggle-btn { position:absolute; bottom:10px; left:320px; padding:8px; font-size:18px; cursor:pointer }
  </style>
</head>
<body>

  <div id="controls">
    <button id="join-btn">התחל שיתוף מסך + מיקרופון</button>
    <button id="toggle-screen" disabled>עצור שיתוף מסך</button>
    <button id="toggle-mic" disabled>כבה מיקרופון</button>
  </div>

  <div id="previews">
    <div id="screen-preview">ממתין לשיתוף מסך…</div>
    <div id="cam-preview">ממתין למצלמה רשמית…</div>
  </div>

  <!-- צ'אט -->
  <div id="chat-container">
    <div id="chat-header">צ'אט</div>
    <div id="chat-messages"></div>
    <form id="chat-form"><input id="chat-input" placeholder="כתוב הודעה…" autocomplete="off"></form>
  </div>
  <button id="chat-toggle-btn">💬</button>

  <!-- Agora SDKs -->
  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <!-- RTM SDK מ-jsDelivr -->
  <script src="https://cdn.jsdelivr.net/npm/agora-rtm-sdk@1.4.4/index.js"></script> :contentReference[oaicite:1]{index=1}
  <script src="config.js"></script>
  <script src="chat.js"></script>

  <script>
    const rtcClient   = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
    rtcClient.setClientRole("host");
    const rtmClient   = AgoraRTM.createInstance(AGORA_APP_ID);

    const p           = new URLSearchParams(location.search);
    const channel     = p.get("channel");
    const uid         = Number(p.get("uid"));
    const officialUid = Number(p.get("official_uid"));

    let screenTrack, micTrack;

    document.getElementById("join-btn").onclick = async () => {
      await rtcClient.join(AGORA_APP_ID, channel, AGORA_TOKEN, uid);
      const name = prompt("הכנס שם בצ'אט:");
      await initChat(rtmClient, channel, uid.toString(), name);

      screenTrack = await AgoraRTC.createScreenVideoTrack({ encoderConfig:"1080p_2", withAudio:true });
      micTrack    = (await AgoraRTC.createMicrophoneAndCameraTracks())[0];
      await rtcClient.publish([ screenTrack, micTrack ]);

      screenTrack.play("screen-preview");
      document.getElementById("toggle-screen").disabled = false;
      document.getElementById("toggle-mic").disabled    = false;
    };

    document.getElementById("toggle-screen").onclick = async () => {
      const btn = document.getElementById("toggle-screen");
      if (screenTrack) {
        await rtcClient.unpublish(screenTrack);
        screenTrack.stop(); screenTrack.close();
        screenTrack = null;
        document.getElementById("screen-preview").innerText = "שיתוף מסך נעצר";
        btn.textContent = "המשך שיתוף מסך";
      } else {
        screenTrack = await AgoraRTC.createScreenVideoTrack({ encoderConfig:"1080p_2", withAudio:true });
        await rtcClient.publish(screenTrack);
        screenTrack.play("screen-preview");
        btn.textContent = "עצור שיתוף מסך";
      }
    };

    document.getElementById("toggle-mic").onclick = () => {
      micTrack.setEnabled(!micTrack.enabled);
      document.getElementById("toggle-mic")
        .textContent = micTrack.enabled ? "כבה מיקרופון" : "הפעל מיקרופון";
    };

    rtcClient.on("user-published", async (user, mediaType) => {
      if (user.uid !== officialUid) return;
      await rtcClient.subscribe(user, mediaType);
      if (mediaType === "video") user.videoTrack.play("cam-preview");
      if (mediaType === "audio") user.audioTrack.play();
    });

    document.getElementById("chat-toggle-btn").onclick = () => {
      const c = document.getElementById("chat-container");
      c.style.display = c.style.display === "flex" ? "none" : "flex";
      if (c.style.display === "flex") c.style.flexDirection = "column";
    };
  </script>
</body>
</html>
