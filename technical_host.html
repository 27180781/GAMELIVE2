<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ממשק מפעיל טכני</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
</head>
<body>
  <h1>ממשק מפעיל טכני</h1>

  <div id="controls">
    <button id="join-btn">הצטרף כמפעיל טכני</button>
    <button id="share-screen-btn" disabled>שתף מסך</button>
    <button id="toggle-camera-btn" disabled>כבה/הפעל מצלמה</button>
    <button id="toggle-mic-btn" disabled>כבה/הפעל מיקרופון</button>
  </div>

  <div id="video-container"></div>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script>
    const client      = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    const urlParams   = new URLSearchParams(location.search);
    const CHANNEL_NAME = urlParams.get('channel');
    const UID          = Number(urlParams.get('uid'));

    let localTracks = { audioTrack: null, videoTrack: null, screenTrack: null };
    let joined = false;

    // 1. הצטרפות ופרסום מיקרופון + מצלמה
    document.getElementById('join-btn').onclick = async () => {
      if (joined) return;
      await client.join(AGORA_APP_ID, CHANNEL_NAME, AGORA_TOKEN, UID);
      const [ audioTrack, videoTrack ] = await AgoraRTC.createMicrophoneAndCameraTracks();
      localTracks.audioTrack = audioTrack;
      localTracks.videoTrack = videoTrack;
      await client.publish([ audioTrack, videoTrack ]);
      joined = true;

      document.getElementById('share-screen-btn').disabled    = false;
      document.getElementById('toggle-camera-btn').disabled   = false;
      document.getElementById('toggle-mic-btn').disabled      = false;

      videoTrack.play(createVideoContainer('local-camera'));
      audioTrack.play();
    };

    // 2. לחיצה על "שתף מסך"
    document.getElementById('share-screen-btn').onclick = async () => {
      const btn = document.getElementById('share-screen-btn');

      if (!localTracks.screenTrack) {
        // מבטלים קודם את שידור המצלמה הרגיל
        await client.unpublish(localTracks.videoTrack);

        // יוצרים ומשדרים את מסך השיתוף
        localTracks.screenTrack = await AgoraRTC.createScreenVideoTrack();
        await client.publish(localTracks.screenTrack);
        localTracks.screenTrack.play(createVideoContainer('local-screen'));

        btn.innerText = 'עצור שיתוף';
      } else {
        // מפסיקים את השיתוף
        await client.unpublish(localTracks.screenTrack);
        localTracks.screenTrack.stop();
        localTracks.screenTrack.close();
        removeVideoContainer('local-screen');
        localTracks.screenTrack = null;

        // משחזרים חזרה את מצלמת הוידאו
        await client.publish(localTracks.videoTrack);
        btn.innerText = 'שתף מסך';
      }
    };

    // 3. כפתור כיבוי/הדלקת מצלמה
    document.getElementById('toggle-camera-btn').onclick = () => {
      const t = localTracks.videoTrack;
      if (!t) return;
      t.setEnabled(!t.enabled);
      document.getElementById('toggle-camera-btn').innerText = t.enabled ? 'כבה מצלמה' : 'הפעל מצלמה';
    };

    // 4. כפתור כיבוי/הדלקת מיקרופון
    document.getElementById('toggle-mic-btn').onclick = () => {
      const t = localTracks.audioTrack;
      if (!t) return;
      t.setEnabled(!t.enabled);
      document.getElementById('toggle-mic-btn').innerText = t.enabled ? 'כבה מיקרופון' : 'הפעל מיקרופון';
    };

    // עזר ליצירת אלמנט וידאו
    function createVideoContainer(id) {
      const div = document.createElement('div');
      div.id = id;
      document.getElementById('video-container').appendChild(div);
      return id;
    }
    function removeVideoContainer(id) {
      const el = document.getElementById(id);
      if (el) el.remove();
    }
  </script>
</body>
</html>
