<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>砖拽 砖拽</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <style>
    body, html { margin: 0; padding: 0; height: 100%; overflow: hidden; font-family: Arial, sans-serif; direction: rtl; }
    #container { display: flex; height: 100vh; }
    /* 3/4 专 砖专 住 */
    #main-video { flex: 3; background: #000; }
    /* 1/4 专 砖+爪 */
    #side-panel { flex: 1; display: flex; flex-direction: column; border-left: 2px solid #333; }
    #game-ui { flex: 2; background: #111; }
    #camera-ui { flex: 1; background: #000; display: flex; align-items: center; justify-content: center; }
    iframe { width: 100%; height: 100%; border: none; }
    video { width: 100%; height: 100%; object-fit: cover; }
    /* 爪'  */
    #chat-container { position: absolute; bottom: 10px; left: 10px; width: 300px; max-height: 400px; background: rgba(0,0,0,0.6); color: #fff; display: none; flex-direction: column; }
    #chat-header { padding: 8px; background: #222; }
    #chat-messages { flex: 1; overflow-y: auto; padding: 8px; }
    #chat-form { display: flex; }
    #chat-input { flex: 1; padding: 6px; }
    #chat-toggle-btn { position: absolute; bottom: 10px; left: 320px; padding: 8px; cursor: pointer; }
  </style>
</head>
<body>

  <div id="container">
    <div id="main-video"></div>
    <div id="side-panel">
      <div id="game-ui">
        <iframe id="gameFrame" src=""></iframe>
      </div>
      <div id="camera-ui">
        <div id="host-video"></div>
      </div>
    </div>
  </div>

  <!-- 爪' -->
  <div id="chat-container">
    <div id="chat-header">爪'</div>
    <div id="chat-messages"></div>
    <form id="chat-form"><input id="chat-input" placeholder="转 注..." autocomplete="off"></form>
  </div>
  <button id="chat-toggle-btn"></button>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script src="https://download.agora.io/rtm/release/AgoraRTM_N-4.14.0.js"></script>
  <script src="chat.js"></script>
  <script>
    const params        = new URLSearchParams(location.search);
    const CHANNEL       = params.get('channel');
    const GAME_CODE     = params.get('gamecode');
    const officialUid   = Number(params.get('official_uid'));
    const technicalUid  = Number(params.get('technical_uid'));

    //  拽砖专 砖 砖拽
    document.getElementById('gameFrame').src =
      `https://game.clicker.co.il/phone.html?code=${encodeURIComponent(GAME_CODE)}`;

    // 转 RTC
    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });
    client.on('user-published', async (user, mediaType) => {
      await client.subscribe(user, mediaType);
      if (mediaType === 'video') {
        // 砖转祝 住 -technicalUid
        if (user.uid === technicalUid) {
          document.getElementById('main-video').innerHTML = '';
          user.videoTrack.play('main-video');
        }
        // 爪转 驻注 专砖 -officialUid
        if (user.uid === officialUid) {
          document.getElementById('host-video').innerHTML = '';
          user.videoTrack.play('host-video');
        }
      }
      if (mediaType === 'audio') {
        user.audioTrack.play();
      }
    });

    (async () => {
      await client.join(AGORA_APP_ID, CHANNEL, AGORA_TOKEN, null);

      // 转 爪' (chat.js)
      await initChat(CHANNEL);
      document.getElementById('chat-toggle-btn').onclick = () => {
        const c = document.getElementById('chat-container');
        c.style.display = c.style.display === 'flex' ? 'none' : 'flex';
      };
    })();
  </script>
</body>
</html>
