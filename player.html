<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ממשק שחקן</title>
  <link rel="stylesheet" href="styles.css">
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family:Arial,sans-serif; direction:rtl; }
    #container { display:flex; height:100vh; }
    #main-video { flex:3; background:#000; position:relative; }
    #main-video video { width:100%; height:100%; object-fit:contain; }
    #side-panel { flex:1; display:flex; flex-direction:column; border-left:2px solid #333; }
    #game-ui { flex:2; background:#111; }
    #camera-ui { flex:1; background:#000; display:flex; align-items:center; justify-content:center; }
    iframe { width:100%; height:100%; border:none; }
    video { width:100%; height:100%; object-fit:cover; }
    #chat-container { position:absolute; bottom:10px; left:10px; width:300px; max-height:400px; display:none; flex-direction:column; background:rgba(0,0,0,0.7); color:#fff; }
    #chat-header { padding:8px; background:#333; }
    #chat-messages { flex:1; overflow-y:auto; padding:8px; }
    #chat-form { display:flex; }
    #chat-input { flex:1; padding:6px; border:none; }
    #chat-toggle-btn { position:absolute; bottom:10px; left:320px; padding:8px; font-size:18px; cursor:pointer; }
  </style>
</head>
<body>

  <div id="container">
    <div id="main-video"></div>
    <div id="side-panel">
      <div id="game-ui">
        <iframe id="gameFrame" src=""></iframe>
      </div>
      <div id="camera-ui">
        <div id="host-video"></div>
      </div>
    </div>
  </div>

  <div id="chat-container">
    <div id="chat-header">צ'אט</div>
    <div id="chat-messages"></div>
    <form id="chat-form"><input id="chat-input" placeholder="כתוב הודעה…" autocomplete="off"></form>
  </div>
  <button id="chat-toggle-btn">💬</button>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/agora-rtm-sdk@1.4.4/index.js"></script>
  <script src="config.js"></script>
  <script src="chat.js"></script>

  <script>
    const p            = new URLSearchParams(location.search);
    const channel      = p.get("channel");
    const gamecode     = p.get("gamecode");
    const officialUid  = Number(p.get("official_uid"));
    const technicalUid = Number(p.get("technical_uid"));

    document.getElementById("gameFrame").src =
      `https://game.clicker.co.il/phone.html?code=${encodeURIComponent(gamecode)}`;

    const rtcClient = AgoraRTC.createClient({ mode:"rtc", codec:"vp8" });
    const rtmClient = AgoraRTM.createInstance(AGORA_APP_ID);

    rtcClient.on("user-published", async (user, mediaType) => {
      await rtcClient.subscribe(user, mediaType);
      if (mediaType==="video") {
        if (user.uid===technicalUid) {
          document.getElementById("main-video").innerHTML="";
          user.videoTrack.play("main-video");
        }
        if (user.uid===officialUid) {
          document.getElementById("host-video").innerHTML="";
          user.videoTrack.play("host-video");
        }
      }
      if (mediaType==="audio") user.audioTrack.play();
    });

    (async () => {
      await rtcClient.join(AGORA_APP_ID, channel, AGORA_TOKEN, null);
      const name = prompt("הכנס שם להצגת צ'אט:");
      await initChat(rtmClient, channel, `player_${Date.now()}`, name);
    })();

    document.getElementById("chat-toggle-btn").onclick = () => {
      const c = document.getElementById("chat-container");
      c.style.display = c.style.display==="flex" ? "none" : "flex";
      if (c.style.display==="flex") c.style.flexDirection="column";
    };
  </script>
</body>
</html>
