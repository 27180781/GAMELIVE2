<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ממשק שחקן</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <style>
    body, html {
      margin: 0;
      padding: 0;
      height: 100%;
      overflow: hidden;
      font-family: Arial, sans-serif;
      direction: rtl;
    }
    #container {
      display: flex;
      height: 100vh;
    }
    /* 1/4 רוחב לשלט+מצלמה */
    #side-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-left: 2px solid #333;
      background: #111;
      overflow: hidden;
    }
    /* 2/3 מהגובה לשלט */
    #game-ui {
      flex: 2;
      background: #222;
    }
    /* 1/3 מהגובה למצלמה */
    #camera-ui {
      flex: 1;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #gameFrame {
      width: 100%;
      height: 100%;
      border: none;
    }
    #host-video {
      width: 100%;
      height: 100%;
      background: #000;
    }
    /* 3/4 רוחב לשידור המסך הממוזג */
    #main-video {
      flex: 3;
      background: #000;
      position: relative;
    }
    #main-video video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }
    /* צ’אט */
    #chat-container { /* כפי ב־styles.css */ }
    #chat-toggle-btn { /* כפי ב־styles.css */ }
  </style>
</head>
<body>

  <div id="container">
    <!-- 1/4 רוחב: שלט המשחק ותצוגת מצלמה -->
    <div id="side-panel">
      <div id="game-ui">
        <iframe id="gameFrame" src=""></iframe>
      </div>
      <div id="camera-ui">
        <div id="host-video"></div>
      </div>
    </div>

    <!-- 3/4 רוחב: שידור המסך הממוזג -->
    <div id="main-video"></div>
  </div>

  <!-- צ’אט -->
  <div id="chat-container">
    <div id="chat-header">צ'אט</div>
    <div id="chat-messages"></div>
    <form id="chat-form"><input id="chat-input" placeholder="כתוב הודעה."></form>
  </div>
  <button id="chat-toggle-btn">💬</button>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script src="https://download.agora.io/rtm/release/AgoraRTM_N-4.14.0.js"></script>
  <script src="config.js"></script>
  <script src="chat.js"></script>
  <script>
    const urlParams    = new URLSearchParams(location.search);
    const CHANNEL_NAME = urlParams.get('channel');
    const GAME_CODE    = urlParams.get('gamecode');
    const officialHostUid = parseInt(urlParams.get('official_uid'));
    const technicalHostUid= parseInt(urlParams.get('tech_uid'));

    // הגדרת שלט המשחק (הקישור עם קוד החדר) ב־iframe
    document.getElementById('gameFrame').src =
      `https://game.clicker.co.il/phone.html?code=${encodeURIComponent(GAME_CODE)}`;

    const rtcClient = AgoraRTC.createClient({ mode: "live", codec: "vp8" });
    rtcClient.setClientRole("audience");
    const rtmClient = AgoraRTM.createInstance(AGORA_APP_ID);

    rtcClient.on("user-published", async (user, mediaType) => {
      await rtcClient.subscribe(user, mediaType);
      if (mediaType === "video") {
        // אם זה merged-track (screen+camera)
        if (user.uid === technicalHostUid) {
          document.getElementById('main-video').innerHTML = "";
          user.videoTrack.play("main-video");
        }
        // אם זו מצלמת המפעיל הרשמי
        if (user.uid === officialHostUid) {
          document.getElementById('host-video').innerHTML = "";
          user.videoTrack.play("host-video");
        }
      }
      if (mediaType === "audio") {
        // מפעיל + שיתוף מסך
        user.audioTrack.play();
      }
    });

    (async () => {
      await rtcClient.join(AGORA_APP_ID, CHANNEL_NAME, AGORA_TOKEN, null);
      await initChat(rtmClient, CHANNEL_NAME, `player_${Date.now()}`, prompt("שם תצוגה בצ'אט:"));
    })();
  </script>
</body>
</html>
