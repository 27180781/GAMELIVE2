<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ממשק שחקן</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <style>
    html, body { margin:0; padding:0; height:100%; overflow:hidden; font-family: Arial, sans-serif; direction: rtl; }
    #container { display: flex; height: 100vh; }

    /* 3/4 רוחב לשידור המסך */
    #main-video {
      flex: 3;
      background: #000;
      position: relative;
    }
    #main-video video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* 1/4 רוחב לשלט + מצלמה */
    #side-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-left: 2px solid #333;
      background: #111;
    }
    /* 2/3 מהגובה לשלט (iframe) */
    #game-ui {
      flex: 2;
      background: #222;
    }
    /* 1/3 מהגובה למצלמה */
    #camera-ui {
      flex: 1;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #gameFrame {
      width: 100%;
      height: 100%;
      border: none;
    }
    #host-video {
      width: 100%;
      height: 100%;
      background: #000;
    }
  </style>
</head>
<body>

  <div id="container">
    <!-- 3/4 לשידור משולב של screen+cam -->
    <div id="main-video"></div>

    <!-- 1/4 לשלט + מצלמה -->
    <div id="side-panel">
      <div id="game-ui">
        <iframe id="gameFrame" src=""></iframe>
      </div>
      <div id="camera-ui">
        <div id="host-video"></div>
      </div>
    </div>
  </div>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script>
    // קריאה לפרמטרים מה-URL
    const params        = new URLSearchParams(location.search);
    const CHANNEL       = params.get('channel');
    const GAME_CODE     = params.get('gamecode');
    const officialUid   = Number(params.get('official_uid'));
    const technicalUid  = Number(params.get('technical_uid'));

    // אתחול ה-iframe של שלט המשחק
    document.getElementById('gameFrame').src =
      `https://game.clicker.co.il/phone.html?code=${encodeURIComponent(GAME_CODE)}`;

    // אתחול לקוח Agora
    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

    client.on('user-published', async (user, mediaType) => {
      // subscribe לכל סוג מדיה
      await client.subscribe(user, mediaType);

      if (mediaType === 'video') {
        // אם זה screen-share מה-technicalUid
        if (user.uid === technicalUid) {
          document.getElementById('main-video').innerHTML = '';
          user.videoTrack.play('main-video');
        }
        // אם זו מצלמת המפעיל הרשמי
        if (user.uid === officialUid) {
          document.getElementById('host-video').innerHTML = '';
          user.videoTrack.play('host-video');
        }
      }

      if (mediaType === 'audio') {
        // נשמע גם screen audio וגם mic מכל הצדדים
        user.audioTrack.play();
      }
    });

    (async () => {
      // הצטרפות כ־subscriber (UID=null כדי לקבל כל USER)
      await client.join(AGORA_APP_ID, CHANNEL, AGORA_TOKEN, null);
      // אין פה publish, רק subscribe
    })();
  </script>

</body>
</html>
