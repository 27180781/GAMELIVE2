<!DOCTYPE html>
<html lang="he" dir="rtl">
<head>
  <meta charset="UTF-8">
  <title>ממשק שחקן</title>
  <link rel="stylesheet" href="styles.css">
  <script src="config.js"></script>
  <style>
    body { margin: 0; padding: 0; direction: rtl; font-family: Arial, sans-serif; }
    #container { display: flex; height: 100vh; }

    /* 3/4 רוחב ל־share screen */
    #main-video {
      flex: 3;
      background: #000;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* 1/4 רוחב לשלט + מצלמה */
    #side-panel {
      flex: 1;
      display: flex;
      flex-direction: column;
      border-left: 2px solid #333;
    }

    /* 2/3 מהגובה לשלט המשחק */
    #game-ui {
      flex: 2;
      background: #111;
    }
    /* 1/3 מהגובה למצלמה */
    #camera-ui {
      flex: 1;
      background: #222;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    /* iframe: שלט המשחק */
    #gameFrame {
      width: 100%;
      height: 100%;
      border: none;
    }

    /* וידאו משולב: share+camera */
    #main-video video {
      width: 100%;
      height: 100%;
      object-fit: contain;
    }

    /* וידאו מצלמה */
    #host-video video {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }
  </style>
</head>
<body>

  <div id="container">
    <!-- 3/4 רוחב: השידור המשולב -->
    <div id="main-video"></div>

    <!-- 1/4 רוחב: שלט + מצלמה -->
    <div id="side-panel">
      <div id="game-ui">
        <iframe
          id="gameFrame"
          src=""
        ></iframe>
      </div>
      <div id="camera-ui">
        <div id="host-video"></div>
      </div>
    </div>
  </div>

  <script src="https://download.agora.io/sdk/release/AgoraRTC_N-4.14.0.js"></script>
  <script>
    const urlParams    = new URLSearchParams(location.search);
    const CHANNEL_NAME = urlParams.get('channel');
    const GAME_CODE    = urlParams.get('gamecode');

    // בונה אוטומטית את הקישור לשלט המשחק עם קוד המשחק
    document.getElementById('gameFrame').src =
      `https://game.clicker.co.il/phone.html?code=${encodeURIComponent(GAME_CODE)}`;

    const client = AgoraRTC.createClient({ mode: 'rtc', codec: 'vp8' });

    client.on('user-published', async (user, mediaType) => {
      await client.subscribe(user, mediaType);

      if (mediaType === 'video') {
        // משמאל: כל השידור המשולב (screen+camera)
        document.getElementById('main-video').innerHTML = '';
        user.videoTrack.play('main-video');
      }

      if (mediaType === 'audio') {
        // מפעיל ומשתף קול גם יחד
        user.audioTrack.play();
      }
    });

    (async () => {
      // מצטרף כ־Subscriber בלבד
      await client.join(AGORA_APP_ID, CHANNEL_NAME, AGORA_TOKEN, null);
    })();
  </script>
</body>
</html>
